#!/bin/bash

## GPLv3
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

SBOPATH=/var/lib/sbopkg/SBo/??.?
ARCH=$(uname -m)
NOCAPS=$(echo "$2" | tr '[:upper:]' '[:lower:]' )
CATEGORY=$(echo "$NOCAPS" | cut -f1 -d"/")
PKG_NAME=$(echo "$NOCAPS" | cut -f2 -d"/")
CWD=$(pwd)


build_pkg() {
    local FILE=${1##*/}
#    echo $FILE
    # TODO account for ARCH
    ULINK=$(cat "$FILE".info | grep DOWNLOAD= | cut -f2 -d\" )
#    echo $ULINK
    wget --no-clobber $ULINK
    ./"$FILE".SlackBuild 2> /tmp/sport.log && ls /tmp/"$FILE"*SBo*t?z
}

# did we get all the info we need to run this script?
if [ $# -lt 2 ]
then
    	echo " "
        echo "Syntax Error. sport needs a verb and a package name:"
	echo "sport search|cat|build|install PACKAGE"
	echo " "
        exit
fi

# the script

case "$1" in
    search)  ls -1 $SBOPATH/*/*"$NOCAPS"*.tar.* | cut -f 7- -d"/" | grep -v .tar.gz.asc 
	;;
    cat)    
	echo " "
	echo "------------------------------------------"
	cat $SBOPATH/"$CATEGORY"/"$PKG_NAME"/{"$PKG_NAME".info,README}
	echo "------------------------------------------"
	echo " " 
	;;
    build)
	tar -xf $SBOPATH/"$CATEGORY"/"$PKG_NAME".tar.gz -C $SBOPATH/"$CATEGORY"/"$PKG_NAME"
	cd $SBOPATH/"$CATEGORY"/"$PKG_NAME"
	build_pkg "$PKG_NAME"
	cd $CWD
	;;
    install)
	tar -xf $SBOPATH/"$CATEGORY"/"$PKG_NAME".tar.gz -C $SBOPATH/"$CATEGORY"/"$PKG_NAME"
	cd $SBOPATH/"$CATEGORY"/"$PKG_NAME"
	build_pkg "$PKG_NAME"
	installpkg /tmp/"$PKG_NAME"*SBo*t?z
	cd $CWD
	;;
esac
